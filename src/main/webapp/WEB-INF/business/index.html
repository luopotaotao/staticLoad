<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="bower_components/jQuery/dist/jquery.js"></script>
    <script type="text/javascript" src="map_api.js"></script>
    <script type="text/javascript" src="AreaRestriction_min.js"></script>
</head>
<body>
<div id="div_map" style="width: 500px;height: 500px"></div>
<script>
    $(window).on('resize',function () {
        console.debug(document.body.clientHeight+' : '+document.body.clientWidth);
        $('#div_map').width(document.body.clientWidth).height(document.body.clientHeight);
    });
    $(function () {
        var map = initializeMap();
        $.extend({
            Map: {
                instance: map,
                center: center,
                showMarkers: function (markers) {
                    showMarkers(markers, function (point) {
                        showInfo(point, '<p>:name</p>', {name: '张三'});
                    });
                },
                showInfo: showInfo
            }

        });
//        var points = [new BMap.Point(113.272,23.134),
//
//            new BMap.Point(113.299,23.124),
//            new BMap.Point(113.251,23.130),
//            new BMap.Point(113.323,23.089),
//            new BMap.Point(113.317,23.128),
//            new BMap.Point(113.232,23.095)];
//
//        var markers = points.map(function(p){return {point:p};});
//
//        $.Map.showMarkers(markers);
        function initializeMap() {
            var map = new BMap.Map("div_map");
//            var point = new BMap.Point(113.276, 23.117);
            map.centerAndZoom("西安", 4);
//            map.centerAndZoom(point, 12);                 // 初始化地图，设置中心点坐标和地图级别
            map.enableScrollWheelZoom(); //启用滚轮放大缩小，默认禁用
            map.enableContinuousZoom(); //启用地图惯性拖拽，默认禁用
            var controls = [
                new BMap.OverviewMapControl(),//添加默认缩略地图控件
                new BMap.OverviewMapControl({isOpen: true, anchor: BMAP_ANCHOR_TOP_RIGHT}), //右上角，打开
                new BMap.NavigationControl(),//添加默认缩略地图控件
                new BMap.NavigationControl({
                    anchor: BMAP_ANCHOR_BOTTOM_LEFT,
                    type: BMAP_NAVIGATION_CONTROL_PAN
                }),//左下角，仅包含平移按钮
                new BMap.NavigationControl({
                    anchor: BMAP_ANCHOR_BOTTOM_RIGHT,
                    type: BMAP_NAVIGATION_CONTROL_ZOOM
                }),//右下角，仅包含缩放按钮
                new BMap.MapTypeControl({mapTypes: [BMAP_NORMAL_MAP, BMAP_HYBRID_MAP]})//2D图，卫星图
            ];
            $.each(controls, function (i, item) {
                map.addControl(item);
            });
            return map;
        }


        function center() {
            map.centerAndZoom("西安", 4);
        }

        //显示markers,挂载点击事件,同时设置地图显示范围
        function showMarkers(markers, callback) {
            if ($.isArray(markers)) {
                var max_lat = 0, max_lng = 0,
                        min_lat = 91, min_lng = 181;

                $.each(markers, function (i, item) {
                    console.log(JSON.stringify(item.point));
                    max_lat = item.point.lat > max_lat ? item.point.lat : max_lat;
                    max_lng = item.point.lng > max_lng ? item.point.lng : max_lng;
                    min_lat = item.point.lat < min_lat ? item.point.lat : min_lat;
                    min_lng = item.point.lng < min_lng ? item.point.lng : min_lng;

                    var marker = new BMap.Marker(item.point);  // 创建标注
                    map.addOverlay(marker);
                    if ($.isFunction(callback)) {
                        marker.addEventListener("click", function () {
                            callback(marker.M);
                        });
                    }
                });
                var lng_span = max_lng - min_lng;
                var lat_span = max_lat - min_lat;
                var sw = new BMap.Point(min_lng - lng_span * 0.2, min_lat - lng_span * 0.2);
                var ne = new BMap.Point(max_lng + lng_span * 0.2, max_lat + lng_span * 0.2);
                var b = new BMap.Bounds(sw, ne);
                try {
                    BMapLib.AreaRestriction.setBounds(map, b);
                } catch (e) {
                    alert(e);
                }
            }
        }

        /**
         * 显示信息窗口
         * @param point 信息窗口点坐标,例如 point = new BMap.Point(116.417854,39.921988)
         * @param template 信息窗口模板,其中要替换的字符串以 :key 的形式 ,例如 <p>:name</p>
         * @param info 要替换的数据json对象,例如 {name:'XXX工程'}
         */
        function showInfo(point, template, info) {
            if ($.isPlainObject(info)) {
                $.each(info, function (key, val) {
                    template = template.replace(new RegExp(':' + key, 'g'), val);
                });
            }
            var infoWindow = new BMap.InfoWindow(template);
            map.openInfoWindow(infoWindow, point);
        }
    })
    ;

</script>
</body>
</html>